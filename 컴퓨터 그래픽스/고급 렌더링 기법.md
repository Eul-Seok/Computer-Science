# 고급 렌더링 기법

기본적인 렌더링 파이프라인 외에도, 사실적인 그래픽을 구현하고 특정 문제를 해결하기 위한 다양한 고급 렌더링 기법들이 존재합니다. 여기서는 3D 그래픽스의 핵심적인 고급 주제인 **회전 표현**, **조명 처리 방식**, **표면 표현**, **물리 기반 렌더링**에 대해 다룹니다.

## 1. 3D 회전과 쿼터니언 (Quaternion)

3D 공간에서 회전을 표현하는 방식에는 <b>오일러 각(Euler Angles)</b>과 <b>쿼터니언(Quaternion)</b>이 주로 사용됩니다. 실시간 그래픽스에서는 대부분 쿼터니언을 사용하는데, 그 이유는 안정성 때문입니다.
> - **오일러 각(Euler Angles)**: X, Y, Z 세 축을 기준으로 각각 회전하는 방식. 직관적이지만 짐벌락 문제가 발생할 수 있습니다.
> - **쿼터니언(Quaternion)**: 4개의 값(w, x, y, z)으로 구성된 수학적 구조로, 하나의 회전축과 회전각을 기반으로 회전을 표현합니다. 짐벌락이 없고 보간에 유리합니다.

-   **오일러 각의 문제점**: X, Y, Z 세 축을 기준으로 각각 회전하는 방식은 직관적이지만, 회전 순서에 따라 결과가 달라지고 특정 각도에서 두 축이 겹쳐 회전 자유도를 잃는 **짐벌락(Gimbal Lock)** 현상이 발생할 수 있습니다.
> - **짐벌락(Gimbal Lock)**: 오일러 각에서 두 회전 축이 정렬되면서 하나의 자유도가 사라져, 회전이 비정상적으로 제한되거나 예측 불가능한 결과를 초래하는 현상.

-   **쿼터니언의 장점**:
    -   **짐벌락 없음**: 4개의 값(w, x, y, z)을 사용하는 **복소수 체계**를 이용하여 회전을 표현하므로, 짐벌락 문제가 원천적으로 발생하지 않습니다.
    > - **복소수 체계**: 실수와 허수를 포함하는 수 체계. 쿼터니언은 3차원 회전을 표현하기 위해 복소수를 확장한 개념을 사용합니다.
    -   **부드러운 보간**: 두 회전 사이를 <b>구면 선형 보간(Slerp)</b>을 통해 최단 경로로 부드럽게 보간할 수 있습니다. 이는 캐릭터 애니메이션이나 카메라 움직임에 매우 중요합니다.
    > - **구면 선형 보간(Slerp, Spherical Linear Interpolation)**: 구면 위에서 두 벡터(또는 쿼터니언) 사이를 일정한 각속도로 부드럽게 보간하는 방법. 회전 애니메이션에 주로 사용됩니다.
    -   이러한 이유로 대부분의 게임 엔진에서는 내부적으로 회전을 쿼터니언으로 처리합니다.

### 다른 회전 표현 방식
-   **회전 행렬 (Rotation Matrix)**: 3x3 행렬로 회전을 표현합니다. 벡터 변환에 직접 사용하기 편리하지만, 여러 회전을 누적할 때 <b>수치적 불안정성(Numerical Instability)</b>이 발생할 수 있고, 보간이 어렵습니다.
> - **수치적 불안정성(Numerical Instability)**: 부동 소수점 연산의 한계로 인해 반복적인 계산에서 오차가 누적되어 결과가 불안정해지는 현상.
-   **축-각 (Axis-Angle)**: 회전 축을 나타내는 벡터와 그 축을 중심으로 회전할 각도로 회전을 표현합니다. 개념적으로 이해하기 쉽지만, 보간에는 쿼터니언이 더 효율적입니다.

## 2. 렌더링 경로: Forward vs. Deferred Rendering

렌더링 경로는 씬에 있는 여러 개의 <b>광원(Light)</b>을 어떻게 계산하여 적용할지에 대한 전략입니다.
> - **광원(Light)**: 3D 씬에 빛을 비추어 오브젝트의 색상과 그림자를 결정하는 요소.

-   **포워드 렌더링 (Forward Rendering)**
    -   **방식**: 각 오브젝트를 렌더링할 때, 해당 오브젝트에 영향을 미치는 모든 광원을 한 번에 계산하여 최종 색상을 결정합니다.
    -   **장점**: 구조가 간단하고, 반투명 객체 처리나 **MSAA** 같은 안티앨리어싱 적용이 용이합니다.
    > - **MSAA (Multi-Sample Anti-Aliasing)**: 픽셀의 경계면에서 여러 샘플을 취해 색상을 평균화하여 계단 현상을 줄이는 안티앨리어싱 기법.
    -   **단점**: 광원의 수가 늘어날수록 오브젝트별 조명 계산이 기하급수적으로 증가하여 성능이 급격히 저하됩니다. (오브젝트 수 x 광원 수)

-   **디퍼드 렌더링 (Deferred Rendering)**
    -   **방식**: 렌더링을 두 <b>패스(Pass)</b>로 나눕니다. 첫 번째 패스(G-Buffer Pass)에서는 화면의 각 픽셀에 대한 정보(색상, 법선, 깊이 등)를 여러 장의 텍스처(**G-buffer**)에 저장합니다. 두 번째 패스(Lighting Pass)에서 이 G-buffer를 사용하여 화면 공간에서 조명 계산을 한 번에 수행합니다.
    > - **패스(Pass)**: 렌더링 파이프라인에서 특정 목적을 위해 한 번의 전체 씬 렌더링을 수행하는 과정.
    > - **G-buffer (Geometry Buffer)**: 디퍼드 렌더링에서 씬의 기하학적 정보(위치, 법선, 색상 등)를 저장하는 여러 장의 텍스처 버퍼.
    -   **장점**: 광원의 수에 거의 영향을 받지 않아 수백, 수천 개의 동적 광원을 효율적으로 처리할 수 있습니다.
    -   **단점**: G-buffer를 위한 추가적인 메모리와 대역폭이 필요하며, 반투명 객체 처리나 MSAA 적용이 까다롭습니다.

### 최신 하이브리드 렌더링 파이프라인
포워드와 디퍼드 렌더링의 장점을 결합한 하이브리드 파이프라인이 많이 사용됩니다.

-   **포워드+ 렌더링 (Forward+ Rendering)**: 포워드 렌더링 기반이지만, **타일(Tile)** 또는 **클러스터(Cluster)** 기반의 광원 컬링(Light Culling)을 통해 광원 수가 많아도 효율적으로 처리할 수 있도록 개선된 방식입니다.
> - **타일(Tile)**: 화면을 작은 사각형 영역으로 나누는 단위. 모바일 GPU에서 효율적인 렌더링을 위해 사용됩니다.
> - **클러스터(Cluster)**: 뷰 프러스텀을 3D 공간에서 작은 볼륨으로 나눈 단위. 각 클러스터에 영향을 미치는 광원 목록을 관리하여 조명 계산을 최적화합니다.
-   **클러스터드 렌더링 (Clustered Rendering)**: **뷰 프러스텀**을 3D 그리드(클러스터)로 나누고, 각 클러스터에 영향을 미치는 광원 목록을 미리 계산하여 픽셀 셰이더에서 필요한 광원만 처리하도록 합니다.
> - **뷰 프러스텀(View Frustum)**: 카메라의 시야를 나타내는 3D 공간. (렌더링 파이프라인의 이해 문서 참고)

## 3. 표면 디테일 표현: Normal vs. Bump Mapping

두 기법 모두 실제 폴리곤을 추가하지 않고, 셰이더 계산만으로 표면에 입체적인 디테일을 추가하는 기술입니다.

-   **범프 매핑 (Bump Mapping)**: 흑백의 높이 맵(Height Map)을 사용하여 픽셀의 높낮이 차이를 기반으로 조명 계산을 간접적으로 왜곡합니다. 계산이 가볍지만, 시선이 표면과 평행에 가까워질수록 입체감이 깨져 보입니다.

-   **노멀 매핑 (Normal Mapping)**: 더 발전된 방식으로, 표면의 **법선(Normal) 벡터** 정보를 텍스처에 직접 저장합니다. 픽셀 셰이더에서 이 노멀 맵을 참조하여 각 픽셀마다 다른 방향의 법선을 적용해 조명을 계산하므로, 훨씬 정교하고 사실적인 입체감을 표현할 수 있습니다. 현대 게임 그래픽에서 사실적인 표면 질감을 위해 보편적으로 사용됩니다.
> - **법선(Normal) 벡터**: 3D 표면의 각 지점에서 표면에 수직인 방향을 나타내는 벡터. 빛의 반사 방향을 결정하는 데 사용됩니다.

### 고급 표면 디테일 기법
노멀 매핑보다 더 사실적인 표면 디테일을 표현하기 위한 기법들입니다.

-   **패럴랙스 매핑 (Parallax Mapping)**: 높이 맵을 사용하여 텍스처 좌표를 <b>시차(Parallax)</b>에 따라 오프셋시켜, 노멀 매핑보다 더 깊이감 있는 입체감을 표현합니다. 실제 지오메트리를 변형하지 않고 텍스처만으로 깊이감을 줍니다.
> - **시차(Parallax)**: 관측자의 위치 변화에 따라 대상이 보이는 방향이나 위치가 달라지는 현상.

-   **디스플레이스먼트 매핑 (Displacement Mapping)**: 높이 맵의 정보를 이용하여 **실제 메시의 정점 위치를 변형**하여 표면의 지오메트리를 물리적으로 변경합니다. 가장 사실적인 입체감을 제공하지만, 폴리곤 수가 크게 증가하여 성능 비용이 높습니다.
> - **메시(Mesh)**: 3D 모델을 구성하는 정점, 간선(Edge), 면(Face)의 집합.

## 4. 물리 기반 렌더링 (PBR, Physically Based Rendering)

**PBR**은 물리 법칙에 기반하여 빛과 재질의 상호작용을 사실적으로 표현하는 렌더링 패러다임입니다.
> - **PBR (Physically Based Rendering)**: 물리 법칙(에너지 보존 등)에 기반하여 빛과 재질의 상호작용을 시뮬레이션하여 사실적인 렌더링 결과를 얻는 기법.

-   **핵심 원리**: **에너지 보존 법칙**, **빛의 양방향 반사 분포 함수(BRDF)** 등 광학 이론을 기반으로 셰이딩을 계산합니다. 이를 통해 아티스트의 감에 의존하던 기존 방식과 달리, 어떤 조명 환경에서도 재질이 일관되고 사실적으로 보이도록 만듭니다.
> - **에너지 보존 법칙**: 빛이 어떤 표면에 닿았을 때, 반사되는 빛의 양은 원래 빛의 양을 초과할 수 없다는 물리 법칙.
> - **BRDF (Bidirectional Reflectance Distribution Function)**: 빛이 표면에 닿았을 때, 어떤 방향에서 들어온 빛이 어떤 방향으로 얼마나 반사되는지를 수학적으로 정의한 함수.

-   **주요 파라미터**:
    -   **알베도 (Albedo)**: 재질이 반사하는 빛의 양과 색상.
    -   **메탈릭 (Metallic)**: 재질이 금속인지 비금속인지를 나타내는 값. 금속은 빛을 대부분 반사하고, 비금속은 일부 흡수하고 확산시킵니다. 1에 가까울수록 금속, 0에 가까울수록 비금속입니다.
    -   **러프니스 (Roughness)**: 표면의 거친 정도. 값이 낮을수록(매끄러움) 거울처럼 선명하게 반사하고, 높을수록(거침) 빛이 넓게 퍼져 뿌옇게 보입니다.
    -   **AO (Ambient Occlusion)**: 오브젝트의 틈새나 접촉면처럼 빛이 잘 닿지 않는 부분에 부드러운 그림자 효과를 주어 깊이감과 사실감을 높이는 파라미터입니다.
    -   **IOR (Index of Refraction)**: 굴절률. 빛이 한 매질에서 다른 매질로 통과할 때 꺾이는 정도를 나타내며, 유리, 물 등 투명하거나 반투명한 재질을 사실적으로 표현하는 데 중요합니다.

### PBR의 사실감 극대화 요소
PBR은 단순히 재질 파라미터뿐만 아니라, 실제 환경의 빛 정보를 활용하여 사실감을 극대화합니다.

-   **환경 맵 (Environment Map)**: 3D 씬을 둘러싼 주변 환경의 빛 정보를 캡처한 텍스처(주로 **큐브맵** 형태)입니다. 주로 큐브맵 형태로 저장되어 오브젝트의 반사나 굴절 효과를 표현하는 데 사용됩니다.
> - **큐브맵(Cubemap)**: 6개의 텍스처를 큐브의 각 면에 매핑하여 360도 전방위 환경을 표현하는 텍스처.
-   **IBL (Image-Based Lighting)**: 이미지 기반 조명. 환경 맵에 저장된 빛 정보를 사용하여 오브젝트에 <b>간접 조명(Ambient Light)</b>과 <b>반사광(Specular Reflection)</b>을 적용하는 기법입니다. 이를 통해 오브젝트가 씬의 조명 환경에 자연스럽게 녹아들게 만듭니다.
> - **간접 조명(Ambient Light)**: 직접적인 광원에서 오는 빛이 아니라, 주변 환경에 의해 반사되어 오브젝트를 은은하게 밝히는 빛.
> - **반사광(Specular Reflection)**: 오브젝트 표면에서 정반사되어 특정 방향으로 강하게 반사되는 빛.

### PBR과 레이 트레이싱 (최신 렌더링 흐름)
PBR은 재질의 물리적 특성을 정의하는 모델이며, 이를 렌더링하는 방식은 래스터라이제이션과 레이 트레이싱 모두에 적용될 수 있습니다. 최신 게임 엔진에서는 PBR 재질을 기반으로 레이 트레이싱을 결합하여 더욱 사실적인 렌더링을 구현합니다.

-   **래스터라이제이션 기반 PBR**:
    -   **방식**: PBR 재질 파라미터(Albedo, Metallic, Roughness 등)를 래스터라이제이션 파이프라인의 셰이더(주로 프래그먼트 셰이더)에 입력하여 조명 계산을 수행합니다.
    -   **특징**: 그림자 맵, 환경 맵, 스크린 스페이스 반사(SSR) 등 다양한 근사 기법을 사용하여 간접 조명, 반사 등을 시뮬레이션합니다. 높은 성능과 광범위한 하드웨어 지원이 장점입니다.
    -   **한계**: 빛의 물리적 경로를 완벽하게 추적하지 못하므로, 전역 조명(Global Illumination), 정확한 반사/굴절 등에서 현실감에 한계가 있습니다.

-   **레이 트레이싱 기반 PBR**:
    -   **방식**: PBR 재질 파라미터가 정의된 오브젝트에 광선(Ray)을 발사하여 빛의 경로를 물리적으로 추적하고, 광선과 오브젝트의 상호작용(반사, 굴절, 흡수)을 PBR 모델에 따라 계산합니다.
    -   **특징**: 빛의 물리적 특성을 정확하게 시뮬레이션하여 매우 사실적인 전역 조명, 반사, 굴절, 그림자 등을 구현할 수 있습니다.
    -   **한계**: 매우 높은 연산 비용이 필요하며, 실시간 적용을 위해서는 레이 트레이싱 전용 하드웨어(RT Cores)가 필수적입니다. 일반적으로 래스터라이제이션과 혼합하는 **하이브리드 렌더링** 방식으로 사용됩니다.

### PBR 워크플로우와 게임 엔진
실무에서 아티스트와 개발자는 PBR 파라미터를 직접 코드로 작성하기보다는, Unity나 Unreal Engine 같은 게임 엔진이 제공하는 직관적인 툴을 활용합니다.
-   **머티리얼 에디터 (Material Editor)**: 노드 기반의 비주얼 스크립팅 환경(예: Unreal Engine의 Material Editor, Unity의 Shader Graph)을 통해 아티스트가 코드를 몰라도 PBR 파라미터를 시각적으로 연결하고 조정하여 원하는 재질을 쉽게 만들 수 있습니다.
-   이러한 워크플로우는 PBR 이론을 실제 게임 에셋에 적용하는 과정을 간소화하여, 높은 품질의 그래픽을 효율적으로 제작하는 데 기여합니다.

PBR은 Unity, Unreal Engine 등 대부분의 현대 게임 엔진에서 기본 렌더링 모델로 채택되어, 높은 품질의 그래픽을 효율적으로 제작하는 표준으로 자리 잡았습니다.
