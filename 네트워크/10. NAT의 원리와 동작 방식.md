# 10. NAT의 원리와 동작 방식

NAT(Network Address Translation, 네트워크 주소 변환)는 내부 네트워크의 **사설 IP 주소**를 하나의 **공인 IP 주소**로 변환하여 외부 인터넷과 통신할 수 있도록 해주는 기술입니다.
> - **사설 IP 주소**: 인터넷상에서 직접 통신할 수 없는 내부용 IP 주소. `192.168.x.x` 등이 대표적이며, 하나의 네트워크 안에서만 유효합니다.
> - **공인 IP 주소**: 전 세계 인터넷에서 유일하게 식별되는 공개된 IP 주소. ISP(인터넷 서비스 제공자)로부터 할당받습니다.

이는 IPv4 주소 고갈 문제를 해결하는 핵심적인 방법이며, 동시에 외부에서 내부로의 직접 접근을 막아주는 **기본적인 방화벽 역할**을 하여 보안을 강화하는 중요한 기능을 합니다.
> - **IPv4 주소 고갈**: 인터넷에 연결된 기기에 부여할 수 있는 IPv4 주소(약 43억 개)가 거의 다 소진된 문제. NAT는 하나의 공인 IP로 여러 기기가 인터넷을 사용하게 해 이 문제를 완화합니다.
> - **방화벽(Firewall)**: 미리 정해진 규칙에 따라 네트워크 트래픽을 차단하거나 허용하는 보안 시스템. 외부의 허가되지 않은 접근으로부터 내부 네트워크를 보호합니다.

## 1. NAT의 기본 원리

일반적으로 가정이나 기업에서 사용하는 내부 네트워크 장비들은 `192.168.x.x`와 같은 사설 IP 대역을 사용합니다. 이 사설 IP는 인터넷상에서 라우팅될 수 없으므로, 인터넷에 접속하려면 공인 IP가 필요합니다.
> - **라우팅(Routing)**: 데이터 패킷이 목적지까지 갈 수 있도록 최적의 경로를 찾아주는 과정. 인터넷의 공유기(라우터)들이 이 역할을 합니다.

NAT는 라우터나 게이트웨이 장비에 탑재되어, 내부 장비가 외부 인터넷으로 통신을 시작할 때 사설 IP를 라우터의 공인 IP로 변환해줍니다. 이 과정에서 **포트 번호**를 함께 사용하여, 여러 내부 장비가 하나의 공인 IP를 공유할 수 있도록 합니다.
> - **게이트웨이(Gateway)**: 서로 다른 프로토콜을 사용하는 두 네트워크를 연결해주는 장치. 공유기(라우터)가 가정의 내부 네트워크와 인터넷을 연결하는 게이트웨이 역할을 겸하는 경우가 많습니다.

-   **동작 과정**:
    1.  내부 PC(`192.168.0.10:5000`)가 외부 서버(`210.89.164.90:80`)로 패킷을 보냅니다.
    > - **패킷(Packet)**: 네트워크를 통해 전송되는 데이터의 작은 조각. 출발지, 목적지 주소, 데이터 내용 등을 담고 있습니다.
    2.  NAT 장비(라우터)는 이 패킷을 받아, 출발지 주소를 자신의 공인 IP와 새로운 포트 번호(`[공인IP]:60000`)로 변경합니다.
    3.  NAT 장비는 이 변환 정보를 **NAT 테이블**에 기록합니다. (`192.168.0.10:5000` <-> `[공인IP]:60000`)
    4.  외부 서버는 공인 IP(`[공인IP]:60000`)로 응답을 보냅니다.
    5.  NAT 장비는 NAT 테이블을 참조하여, 응답 패킷의 목적지 주소를 원래의 사설 IP(`192.168.0.10:5000`)로 다시 변경하여 내부 PC에 전달합니다.

이처럼 포트 번호를 이용해 주소를 변환하는 방식을 특별히 **PAT(Port Address Translation)** 또는 **NAPT(Network Address Port Translation)** 라고 부르며, 현재 가장 널리 사용되는 NAT 방식입니다.

## 2. NAT 종류: P2P 통신을 어렵게 만드는 이유

NAT의 동작 방식은 P2P 통신 성공 여부에 큰 영향을 미칩니다. NAT는 외부에서 들어오는 패킷을 처리하는 정책에 따라 다음과 같이 구분되며, 이로 인해 STUN/TURN의 필요성이 더 명확해집니다.

-   **Full Cone NAT (Type 1)**
    -   가장 개방적인 방식으로, 내부 클라이언트가 한 번이라도 외부로 패킷을 보낸 적이 있다면, 그 후에는 **어떤 외부 호스트로부터라도** 해당 포트로 들어오는 패킷을 허용합니다. P2P 통신에 가장 유리합니다.

-   **Restricted Cone NAT (Type 2)**
    -   내부 클라이언트가 특정 외부 서버(IP 주소)에 패킷을 보냈을 경우, **해당 서버의 IP 주소에서 오는 패킷만** 허용합니다. 포트 번호에는 제한을 두지 않습니다.

-   **Port Restricted Cone NAT (Type 3)**
    -   Restricted Cone NAT보다 한층 더 제한적입니다. 내부 클라이언트가 특정 외부 서버(IP:Port)에 패킷을 보냈을 경우, **정확히 동일한 IP와 포트에서 오는 패킷만** 허용합니다.

-   **Symmetric NAT (Type 4)**
    -   가장 제한적인 방식으로, 내부 클라이언트가 외부의 특정 목적지(IP:Port)로 요청을 보낼 때마다 **매번 다른 외부 포트**를 할당합니다. 즉, 통신하는 상대방에 따라 NAT 테이블의 매핑 정보가 계속 변경됩니다.
    -   이 때문에 두 클라이언트가 서로의 공인 IP/포트를 알아내도, NAT 장비가 패킷을 차단하므로 직접 통신이 거의 불가능합니다. **TURN 서버를 통한 릴레이가 필수적**인 경우가 많습니다.

## 3. P2P 통신과 NAT Traversal

NAT는 보안에는 도움이 되지만, 각 클라이언트가 서버 역할을 해야 하는 **P2P(Peer-to-Peer) 통신**에는 큰 장애물이 됩니다.
> - **P2P 통신**: 중앙 서버를 거치지 않고, 클라이언트(Peer)끼리 직접 데이터를 주고받는 통신 방식. 파일 공유, 실시간 게임, 화상 회의 등에 사용됩니다.

외부에서 내부 네트워크로의 연결 요청은 위에서 설명한 NAT 종류에 따라 대부분 차단되기 때문에, NAT 환경에 있는 클라이언트끼리 직접 통신하기가 어렵습니다.

온라인 게임, 화상 회의 등에서 이 문제를 해결하기 위해 **NAT Traversal(NAT 통과)** 기법이 사용됩니다.

### NAT Traversal 기법

-   **STUN (Session Traversal Utilities for NAT)**
    -   클라이언트가 자신의 공인 IP 주소와 포트 번호, 그리고 자신이 어떤 종류의 NAT 뒤에 있는지 파악할 수 있도록 도와주는 프로토콜입니다.
    -   클라이언트는 STUN 서버에 요청을 보내고, STUN 서버는 요청 패킷의 출발지 주소(NAT에 의해 변환된 공인 IP/포트)를 클라이언트에게 알려줍니다.
    -   클라이언트는 이 정보를 **시그널링**을 통해 상대방에게 전달하여 직접 통신을 시도할 수 있습니다.
    > - **시그널링(Signaling)**: P2P 통신을 시작하기 전에, 클라이언트들이 서로의 주소 정보(IP, 포트 등)를 교환하고 통신 설정을 조율하는 과정. 웹소켓이나 별도의 HTTP 서버 등 P2P 통신 채널과 분리된 경로를 사용합니다.

-   **TURN (Traversal Using Relays around NAT)**
    -   STUN 방식으로도 직접 연결이 불가능한 경우(예: Symmetric NAT)를 위한 최후의 수단입니다.
    -   TURN 서버가 두 클라이언트 사이의 모든 트래픽을 중계하는 **릴레이 서버** 역할을 합니다.
    > - **릴레이 서버(Relay Server)**: 두 클라이언트 간의 직접 통신이 불가능할 때, 중간에서 데이터를 대신 전달해주는 서버. 모든 데이터가 서버를 거치므로 지연이 발생할 수 있습니다.
    -   모든 데이터가 서버를 거치므로 지연 시간이 증가하고 서버 유지 비용이 발생하지만, 가장 확실하게 P2P 통신을 보장하는 방법입니다.

-   **ICE (Interactive Connectivity Establishment)**
    -   STUN과 TURN을 종합적으로 사용하여 최적의 통신 경로를 찾아내는 프레임워크입니다.
    > - **프레임워크(Framework)**: 특정 문제를 해결하기 위한 규칙, 구조, 라이브러리의 집합. ICE는 P2P 연결 문제를 해결하기 위한 정해진 절차와 규칙을 제공합니다.
    -   ICE는 다음과 같은 순서로 연결을 시도합니다.
        1.  로컬 네트워크 내에서 직접 연결 시도
        2.  STUN을 통해 얻은 공인 IP 주소로 직접 연결 시도
        3.  TURN 서버를 통한 릴레이 연결 시도
    -   이 과정을 통해 가능한 한 직접 연결을 유도하고, 실패할 경우에만 릴레이 서버를 사용하여 효율성과 안정성을 모두 확보합니다.

### NAT Traversal의 실무 예시

NAT Traversal 기술은 실시간 통신이 중요한 다양한 서비스에서 핵심적인 역할을 합니다.

-   **WebRTC 기반 화상 회의**: Google Meet, Zoom과 같은 서비스에서 사용자들이 브라우저를 통해 서로 직접 영상과 음성을 주고받을 수 있도록 합니다.
-   **온라인 게임 및 모바일 게임**: 멀티플레이어 게임에서 플레이어 간의 지연 시간을 최소화하기 위해 P2P 연결을 구성합니다. 실시간 매칭 후 플레이어들을 직접 연결하는 데 사용됩니다.
-   **P2P 파일 공유**: BitTorrent와 같은 파일 공유 시스템에서 사용자들이 중앙 서버 없이 파일을 직접 주고받을 수 있도록 돕습니다.

## 4. 실무적 고려사항 및 게임 개발 관점

NAT Traversal은 이론적으로 강력하지만, 실제 환경에서는 여러 변수와 마주하게 됩니다.

### 성능 최적화와 연결 전략

-   **STUN 우선, TURN은 최후의 보루**: 실시간 게임에서 지연 시간(Latency)은 매우 중요합니다.
> - **지연 시간(Latency)**: 데이터가 출발지에서 목적지까지 도달하는 데 걸리는 시간. '랙(Lag)'의 주된 원인이며, 실시간 상호작용에 큰 영향을 줍니다.
-   TURN 서버를 통한 릴레이는 패킷이 서버를 한 번 거쳐가므로 필연적으로 지연이 추가됩니다. 따라서 ICE 프레임워크의 핵심 전략은 **STUN을 통해 어떻게든 P2P 직접 연결을 성공시키는 것**입니다. TURN은 P2P가 불가능한 최악의 경우에만 사용하는 비상구(fallback) 역할로 한정해야 합니다.

### NAT Traversal 실패와 대응

-   **연결 실패 사례**: 일부 기업이나 기관의 방화벽은 보안 정책상 UDP 트래픽 자체를 차단하거나, STUN/TURN 프로토콜의 패턴을 감지하여 막는 경우가 있습니다.
> - **UDP(User Datagram Protocol)**: TCP와 달리 연결 설정 없이 데이터를 빠르게 전송하는 프로토콜. 속도가 중요하고 일부 데이터 손실을 감수할 수 있는 실시간 게임이나 스트리밍에 주로 사용됩니다.
-   이 경우 ICE의 모든 시도가 실패하고 P2P 연결이 불가능해집니다.
-   **Fallback 전략**: P2P 연결에 최종적으로 실패하면, 모든 통신을 일반적인 클라이언트-서버 모델로 전환하는 것이 현실적인 대안입니다.
> - **클라이언트-서버 모델(Client-Server Model)**: 모든 클라이언트가 중앙 서버에 접속하여 통신하는 전통적인 온라인 구조. P2P보다 안정적이지만 서버 유지 비용과 트래픽 부담이 큽니다.
> - **TCP(Transmission Control Protocol)**: UDP와 달리, 데이터를 보내기 전 상대방과 연결을 설정하고 데이터가 순서대로, 빠짐없이 도착했는지 확인하는 신뢰성 높은 프로토콜. 웹 브라우징, 파일 전송 등 신뢰성이 중요할 때 사용됩니다.
-   예를 들어, WebRTC는 TURN을 통한 TCP 릴레이를 시도하거나, 아예 모든 로직을 서버가 처리하도록 구성할 수 있습니다.

### 상용 솔루션 활용 및 비교

-   **직접 구현의 어려움**: 안정적인 NAT Traversal 로직을 직접 구현하는 것은 매우 복잡하고 많은 예외 처리가 필요합니다. 전 세계의 다양한 네트워크 환경을 모두 테스트하기도 어렵습니다.
-   **현실적인 선택**: 대부분의 게임 개발 프로젝트에서는 직접 구현하기보다 **검증된 상용 솔루션**을 사용합니다. 각 솔루션은 특징이 명확하여 프로젝트의 규모, 예산, 엔진에 따라 선택이 달라집니다.

| 솔루션                  | 주요 특징                                           | 장점                                                                                             | 단점                                               |
| :---------------------- | :-------------------------------------------------- | :----------------------------------------------------------------------------------------------- | :------------------------------------------------- |
| **Unity Relay**         | Unity 엔진에 내장된 릴레이 서비스                   | - Unity 프로젝트에 통합이 매우 간편함<br>- 엔진과 긴밀하게 연동됨                                 | - Unity 생태계에 종속적임<br>- 기능이 릴레이에 집중되어 있음 |
| **Photon (PUN, Fusion)** | 가장 널리 쓰이는 게임 네트워킹 솔루션         | - Unity, Unreal 등 멀티 엔진 지원<br>- 신뢰성 높고 풍부한 기능 (매치메이킹, 동기화 등)<br>- 다양한 요금제 및 무료 티어 제공 | - 별도 SDK 학습 필요<br>- 대규모 트래픽 발생 시 비용 증가 |
| **Epic Online Services (EOS)** | Epic Games가 제공하는 무료 크로스 플랫폼 서비스 | - **완전 무료** (별도 수익 모델 없음)<br>- P2P, 릴레이, 보이스챗 등 종합 기능 제공<br>- Unreal 엔진과 통합이 용이하며 타 엔진도 지원 | - Epic Games 생태계에 대한 일부 의존성<br>- 비교적 후발주자 (Photon 대비) |
> - **SDK(Software Development Kit)**: 특정 소프트웨어나 플랫폼을 위한 애플리케이션을 쉽게 만들 수 있도록 도와주는 개발 도구 모음.
> - **매치메이킹(Matchmaking)**: 실력이나 지역 등 조건이 비슷한 플레이어들을 찾아 게임 세션으로 묶어주는 기능.
> - **동기화(Synchronization)**: 여러 플레이어의 게임 상태(위치, 행동 등)를 실시간으로 일치시키는 기술.
> - **보이스챗(Voice Chat)**: 게임 내 음성 대화 기능.

### 보안 고려사항

-   **신뢰할 수 없는 서버**: STUN/TURN 서버가 악의적으로 조작되거나 해킹당할 경우, 클라이언트에게 잘못된 IP 주소를 알려주어 연결을 방해하거나 악성 피어에게 연결하도록 유도할 수 있습니다.
-   **중간자 공격 (MitM)**: P2P 연결 후보(IP, 포트)를 교환하는 시그널링 과정이 암호화되지 않으면, 공격자가 중간에서 통신을 가로채 연결 정보를 변조할 수 있습니다.
-   **대응 방안**:
    -   시그널링 서버와 클라이언트 간 통신은 반드시 **TLS**와 같은 암호화된 채널을 사용해야 합니다.
    > - **TLS(Transport Layer Security)**: 인터넷 통신을 암호화하여 제3자가 데이터를 엿보거나 조작할 수 없도록 보호하는 표준 보안 프로토콜. HTTPS의 핵심 기술입니다.
    -   TURN 서버에는 단기 자격증명(short-term credentials)과 같은 인증 메커니즘을 도입하여 허가된 사용자만 릴레이를 사용하도록 제한합니다. (WebRTC의 `DTLS-SRTP`가 대표적)
    > - **단기 자격증명**: 짧은 시간 동안만 유효한 임시 비밀번호나 토큰. TURN 서버 접근을 안전하게 제어하는 데 사용됩니다.
    > - **DTLS-SRTP**: WebRTC에서 미디어(영상, 음성) 데이터를 암호화하여 안전하게 전송하기 위한 프로토콜. DTLS는 UDP 기반의 TLS이며, SRTP는 실시간 미디어 데이터를 위한 보안 프로토콜입니다.

## 5. 결론

결국 NAT는 IP 주소 자원의 효율적 사용과 보안 강화를 위한 핵심 기술입니다. P2P 통신이 필수적인 게임, 화상 회의 등의 분야에서는 **STUN, TURN, ICE 기반의 NAT Traversal**을 통해 연결 성공률을 높입니다.

하지만 실제 개발에서는 지연 시간을 최소화하기 위해 P2P 연결을 최우선으로 시도하고, 연결 실패나 구현의 복잡성을 고려하여 **상용 솔루션을 도입**하는 것이 일반적인 접근 방식입니다. 따라서 NAT와 NAT Traversal의 원리를 이해하는 것은 안정적인 멀티플레이어 환경을 구축하기 위한 필수적인 기초 지식이라 할 수 있습니다.