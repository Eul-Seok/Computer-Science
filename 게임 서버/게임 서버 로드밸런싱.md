# 11. 게임 서버 로드밸런싱 (Load Balancing)

## 1. 로드밸런싱이란?

<b>로드밸런싱(Load Balancing)</b>은 클라이언트의 요청을 여러 대의 서버에 효율적으로 분산시켜 처리하는 기술입니다. 특정 서버 하나에 모든 요청이 집중되는 것을 방지하여 시스템 전체의 부하를 분산시키고, 이를 통해 서비스의 안정성과 확장성, <b>가용성(High Availability)</b>을 높이는 것을 목표로 합니다.
> - **가용성(High Availability)**: 서버나 네트워크 등 시스템이 장애 없이 오랜 시간 동안 정상적으로 운영될 수 있는 능력. '고가용성'이라고도 하며, 서비스 중단의 최소화를 의미합니다.

## 2. 게임 서버에서 로드밸런싱이 중요한 이유

게임 서버는 수많은 클라이언트가 동시에 접속하여 실시간으로 데이터를 주고받는 환경이므로, 트래픽을 효과적으로 분산하지 않으면 다음과 같은 심각한 문제가 발생할 수 있습니다.

-   **서버 과부하**: 단일 서버에 트래픽이 몰리면 CPU, 메모리 등 리소스가 한계에 도달하여 지연(Latency) 증가, 랙(Lag), 접속 실패 등이 발생합니다.
-   **서비스 중단**: 서버 장애 발생 시 해당 서버에 접속한 모든 유저가 서비스를 이용할 수 없게 됩니다. 로드밸런싱은 헬스 체크(Health Check)를 통해 장애가 발생한 서버를 트래픽 분산 대상에서 제외하여 서비스 연속성을 보장합니다.
> - **헬스 체크(Health Check)**: 로드밸런서가 주기적으로 서버에 간단한 요청을 보내 응답이 오는지 확인하는 과정. 이를 통해 서버의 정상 작동 여부를 판단합니다.
-   **확장성의 한계**: 사용자가 증가할 때 단일 서버의 사양을 높이는 **Scale-up** 방식만으로는 한계가 명확합니다. 로드밸런싱은 서버를 추가하는 **Scale-out** 방식을 통해 유연하게 트래픽 증가에 대응할 수 있게 해줍니다.
> - **Scale-up**: 기존 서버의 하드웨어 사양(CPU, RAM 등)을 높여 성능을 향상시키는 방식.
> - **Scale-out**: 비슷한 사양의 서버 대수를 늘려 전체 시스템의 처리 능력을 향상시키는 방식. 로드밸런싱은 Scale-out 구조의 핵심입니다.

특히 MMORPG나 실시간 PvP 게임처럼 동시 접속자가 많은 경우, 로드밸런싱 없이는 원활한 서비스가 거의 불가능합니다.
> - **MMORPG(Massively Multiplayer Online Role-Playing Game)**: 수천, 수만 명의 플레이어가 하나의 가상 세계에 동시 접속하여 플레이하는 대규모 온라인 롤플레잉 게임.

## 3. 로드밸런서의 종류 (계층별)

로드밸런서는 동작하는 네트워크 계층(OSI 7계층)에 따라 크게 **L4 로드밸런싱**과 **L7 로드밸런싱**으로 나뉩니다.
> - **OSI 7계층**: 네트워크 통신 과정을 7개의 논리적인 단계로 나눈 모델. 로드밸런서는 이 중 4계층(전송 계층) 또는 7계층(응용 계층)에서 동작합니다.

### L4 로드밸런싱
-   **원리**: 네트워크 계층(Layer 4, Transport Layer)에서 동작하며, IP 주소와 포트 번호를 기반으로 트래픽을 분산합니다. 패킷의 헤더 정보만 확인하고 요청을 전달하므로 속도가 매우 빠릅니다.
> - **패킷 헤더(Packet Header)**: 패킷의 앞부분에 위치하며, 출발지/목적지 IP 주소, 포트 번호 등 해당 패킷을 어떻게 처리해야 할지에 대한 제어 정보가 담겨 있습니다.
-   **장점**:
    -   빠른 처리 속도: 패킷 내용을 분석하지 않아 부하가 적습니다.
    -   다양한 프로토콜 지원: TCP, UDP 등 프로토콜 종류에 상관없이 분산 처리가 가능합니다.
-   **단점**:
    -   정교한 분산 불가: 패킷의 내용(URL, HTTP 헤더 등)을 볼 수 없어, 세션 정보나 특정 콘텐츠에 따른 분산이 불가능합니다.

### L7 로드밸런싱
-   **원리**: 애플리케이션 계층(Layer 7, Application Layer)에서 동작하며, HTTP 헤더, 쿠키, URL 등 사용자의 요청 내용을 분석하여 트래픽을 분산합니다.
-   **장점**:
    -   정교한 라우팅: 특정 URL 경로나 쿼리 파라미터에 따라 다른 서버 그룹으로 요청을 보내는 등 유연한 정책 설정이 가능합니다.
    -   **세션 유지(Sticky Session)**: 쿠키나 세션 ID를 기반으로 특정 클라이언트의 요청을 항상 동일한 서버로 보내 세션 정보를 유지할 수 있습니다.
    > - **세션(Session)**: 클라이언트와 서버 간의 연결이 유지되는 상태 또는 그 기간. 로그인 정보, 장바구니 내용 등 사용자의 상태 정보를 서버가 기억하게 해줍니다.
-   **단점**:
    -   상대적으로 느린 속도: 패킷 내용을 분석하고 SSL 복호화까지 수행하는 경우 L4보다 부하가 크고 처리 속도가 느릴 수 있습니다.
    > - **SSL 복호화(SSL Decryption)**: 암호화된 HTTPS 트래픽(SSL/TLS)을 로드밸런서가 해독하여 내용을 확인하는 과정. 정교한 L7 라우팅을 위해 필요하지만, 추가적인 연산 비용이 발생합니다.

## 4. 로드밸런싱 알고리즘

-   **라운드 로빈 (Round Robin)**: 서버들에게 요청을 순서대로 균등하게 분배합니다. 가장 간단하고 보편적인 방식입니다.
-   **최소 연결 (Least Connection)**: 현재 연결(세션) 수가 가장 적은 서버에게 다음 요청을 보냅니다. 서버의 처리 능력이 다를 때 효과적입니다.
-   **IP 해시 (IP Hash)**: 클라이언트의 IP 주소를 해싱하여 특정 서버로만 요청을 보냅니다. 세션 유지가 필요한 경우에 사용될 수 있습니다.
> - **해싱(Hashing)**: 임의의 길이의 데이터를 고정된 길이의 데이터(해시 값)로 변환하는 과정. 동일한 입력값은 항상 동일한 출력값을 보장하므로, IP 주소를 특정 서버에 매핑하는 데 사용될 수 있습니다.
-   **가중치 기반 (Weighted Round Robin, Weighted Least Connection)**: 각 서버의 처리 성능에 따라 가중치를 부여하여, 성능이 좋은 서버에 더 많은 트래픽을 할당합니다.

## 5. 게임 서버 환경의 특수 고려사항

-   **세션 유지 (Session Persistence)**: 많은 게임 서버는 유저의 상태 정보(Stateful)를 메모리에 저장합니다.
> - **Stateful (상태 유지)**: 서버가 클라이언트의 이전 요청 정보를 기억하고 다음 요청 처리 시 이를 활용하는 방식. 로그인 상태, 게임 내 위치 등이 예시입니다. 반대말은 Stateless입니다.
-   이 경우, 한 유저의 연속적인 요청은 반드시 동일한 서버로 전달되어야 합니다. L7 로드밸런서의 'Sticky Session' 기능이나 별도의 세션 클러스터링 솔루션을 통해 이를 해결합니다.
> - **세션 클러스터링(Session Clustering)**: 여러 서버가 세션 정보를 실시간으로 공유하는 기술. 특정 서버에 장애가 발생해도 다른 서버가 세션 정보를 이어받아 서비스를 계속할 수 있습니다.
-   **UDP 트래픽 처리**: 실시간 게임 데이터는 주로 UDP 프로토콜을 사용합니다. L7 로드밸런서는 대부분 TCP/HTTP 기반이므로, **UDP 트래픽 분산**에는 주로 L4 로드밸런서가 사용됩니다.
-   **글로벌 서버 로드밸런싱 (GSLB)**: 전 세계 유저를 대상으로 서비스할 경우, 지리적으로 분산된 서버 중 사용자에게서 가장 가까운 데이터센터로 연결되도록 하여 지연 시간을 최소화합니다. DNS 기반 로드밸런싱이나 전문 GSLB 솔루션을 사용합니다.
> - **DNS(Domain Name System)**: `game.example.com`과 같은 도메인 이름을 실제 서버의 IP 주소로 변환해주는 시스템. GSLB에서는 사용자의 위치에 따라 가장 가까운 서버의 IP를 알려주는 방식으로 로드밸런싱을 수행합니다.